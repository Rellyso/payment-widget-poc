# üì¶ Guia de Publica√ß√£o - Cart√£o Simples Widget

Este guia explica como instalar, configurar e publicar o **Cart√£o Simples Payment Widget** em diferentes formatos: **SDK npm**, **CDN**, e **Bootstrap Loader**.

## üìã √çndice

1. [Pr√©-requisitos](#pr√©-requisitos)
2. [Configura√ß√£o do Ambiente](#configura√ß√£o-do-ambiente)
3. [Build e Desenvolvimento](#build-e-desenvolvimento)
4. [Publica√ß√£o SDK npm](#publica√ß√£o-sdk-npm)
5. [Deploy CDN](#deploy-cdn)
6. [Configura√ß√£o Bootstrap](#configura√ß√£o-bootstrap)
7. [Versionamento](#versionamento)
8. [Troubleshooting](#troubleshooting)

---

## üõ†Ô∏è Pr√©-requisitos

### Ferramentas Necess√°rias

- **Node.js** 18+ e **npm** 8+
- **Git** para controle de vers√£o
- **AWS CLI** (para deploy CDN)
- **Conta npm** (para publica√ß√£o SDK)

### Verificar Instala√ß√£o

```bash
# Verificar vers√µes
node --version    # >=18.0.0
npm --version     # >=8.0.0
git --version     # >=2.0.0
aws --version     # >=2.0.0 (opcional)

# Verificar login npm
npm whoami        # Deve mostrar seu username
```

---

## ‚öôÔ∏è Configura√ß√£o do Ambiente

### 1. Clone do Reposit√≥rio

```bash
# Clonar projeto
git clone https://github.com/cartao-simples/widget.git
cd widget

# Instalar depend√™ncias
npm ci

# Verificar se tudo est√° funcionando
npm run type-check
npm run lint
```

### 2. Configura√ß√£o de Vari√°veis

Crie um arquivo `.env.local`:

```bash
# .env.local
VITE_MERCHANT_ID=seu-merchant-id
VITE_API_BASE_URL=https://api.cartaosimples.com
VITE_CDN_BASE_URL=https://cdn.cartaosimples.com
VITE_ENVIRONMENT=development
```

### 3. Teste Local

```bash
# Iniciar servidor de desenvolvimento
npm run dev

# Verificar em: http://localhost:5173
```

---

## üèóÔ∏è Build e Desenvolvimento

### Scripts Dispon√≠veis

```bash
# Desenvolvimento
npm run dev                 # Servidor dev local
npm run preview            # Preview do build de produ√ß√£o

# Build completo
npm run build              # SDK + CDN
npm run build:sdk          # Apenas SDK (npm)
npm run build:cdn          # Apenas CDN bundle  
npm run build:bootstrap    # Apenas bootstrap loader

# Qualidade
npm run lint               # Verificar c√≥digo
npm run lint:fix           # Corrigir automaticamente
npm run type-check         # Verificar tipos TypeScript
```

### Estrutura dos Builds

```
dist/
‚îú‚îÄ‚îÄ sdk/                   # Para npm publish
‚îÇ   ‚îú‚îÄ‚îÄ index.js          # CommonJS
‚îÇ   ‚îú‚îÄ‚îÄ index.es.js       # ES Modules
‚îÇ   ‚îî‚îÄ‚îÄ index.d.ts        # TypeScript definitions
‚îú‚îÄ‚îÄ cdn/                   # Para CDN deploy
‚îÇ   ‚îú‚îÄ‚îÄ widget.v1.min.css       # Styles
‚îÇ   ‚îî‚îÄ‚îÄ widget.v1.min.umd.cjs   # Bundle completo
‚îî‚îÄ‚îÄ bootstrap/             # Loader leve
    ‚îî‚îÄ‚îÄ widget-bootstrap.v1.min.umd.cjs  # 1.8KB gzipped
```

### Verificar Builds

```bash
# Build completo
npm run build

# Verificar tamanhos
ls -lah dist/sdk/
ls -lah dist/cdn/
ls -lah dist/bootstrap/

# Verificar se JS √© v√°lido
node -c dist/sdk/index.js
node -c dist/cdn/widget.v1.min.umd.cjs
node -c dist/bootstrap/widget-bootstrap.v1.min.umd.cjs
```

---

## üì¶ Publica√ß√£o SDK npm

### 1. Prepara√ß√£o

```bash
# Limpar e rebuild
rm -rf dist/ node_modules/
npm ci
npm run build:sdk

# Verificar conte√∫do do pacote
npm pack --dry-run

# Visualizar arquivos que ser√£o publicados
tar -tzf cartao-simples-widget-1.0.0.tgz
```

### 2. Testes Locais

```bash
# Testar instala√ß√£o local
npm pack
cd /tmp
mkdir test-widget && cd test-widget
npm init -y
npm install /caminho/para/cartao-simples-widget-1.0.0.tgz

# Testar importa√ß√£o
node -e "console.log(require('cartao-simples-widget'))"
```

### 3. Publica√ß√£o

```bash
# Login npm (se necess√°rio)
npm login

# Verificar configura√ß√£o
npm config get registry  # Deve ser https://registry.npmjs.org/

# Publica√ß√£o (primeira vez)
npm publish

# Publica√ß√£o de novas vers√µes
npm version patch  # 1.0.0 ‚Üí 1.0.1
npm version minor  # 1.0.1 ‚Üí 1.1.0  
npm version major  # 1.1.0 ‚Üí 2.0.0

npm publish
```

### 4. Verificar Publica√ß√£o

```bash
# Verificar no npm
npm view cartao-simples-widget
npm view cartao-simples-widget versions --json

# Instalar de verdade
npm install cartao-simples-widget
```

### 5. Tags e Distribui√ß√£o

```bash
# Publicar vers√£o beta
npm version prerelease --preid=beta  # 1.0.0-beta.1
npm publish --tag beta

# Publicar vers√£o est√°vel
npm publish --tag latest

# Gerenciar tags
npm dist-tag add cartao-simples-widget@1.0.0-beta.1 beta
npm dist-tag add cartao-simples-widget@1.0.0 latest
```

---

## ‚òÅÔ∏è Deploy CDN

### 1. Configura√ß√£o AWS

```bash
# Configurar credenciais (primeira vez)
aws configure
# AWS Access Key ID: [sua-key]
# AWS Secret Access Key: [sua-secret]  
# Default region: us-east-1
# Default output format: json

# Verificar configura√ß√£o
aws sts get-caller-identity
```

### 2. Build CDN

```bash
# Gerar builds CDN
npm run build:cdn
npm run build:bootstrap

# Verificar arquivos gerados
ls -la dist/cdn/
ls -la dist/bootstrap/
```

### 3. Deploy Autom√°tico

```bash
# Dar permiss√£o ao script
chmod +x deploy.sh

# Deploy para staging
./deploy.sh staging

# Deploy para production
./deploy.sh production
```

### 4. Deploy Manual S3

```bash
# Criar bucket (se n√£o existir)
aws s3 mb s3://cartao-simples-widget-production --region us-east-1

# Upload bootstrap (cache curto - 5min)
aws s3 cp dist/bootstrap/widget-bootstrap.v1.min.umd.cjs \
  s3://cartao-simples-widget-production/widget-bootstrap.v1.min.js \
  --content-type "application/javascript" \
  --cache-control "public, max-age=300" \
  --metadata-directive REPLACE

# Upload CDN bundle (cache longo - 1 ano)  
aws s3 cp dist/cdn/widget.v1.min.umd.cjs \
  s3://cartao-simples-widget-production/widget.v1.min.js \
  --content-type "application/javascript" \
  --cache-control "public, max-age=31536000" \
  --metadata-directive REPLACE

# Upload CSS
aws s3 cp dist/cdn/widget.v1.min.css \
  s3://cartao-simples-widget-production/widget.v1.min.css \
  --content-type "text/css" \
  --cache-control "public, max-age=31536000" \
  --metadata-directive REPLACE
```

### 5. CloudFront Setup

```bash
# Criar distribui√ß√£o CloudFront
aws cloudfront create-distribution --distribution-config file://cloudfront.json

# Obter ID da distribui√ß√£o  
aws cloudfront list-distributions --query 'DistributionList.Items[0].Id' --output text

# Invalidar cache ap√≥s deploy
aws cloudfront create-invalidation \
  --distribution-id E1ABCDEFGHIJKL \
  --paths "/*"
```

### 6. Configurar DNS

```bash
# Exemplo com Route 53
aws route53 change-resource-record-sets \
  --hosted-zone-id Z123456789 \
  --change-batch '{
    "Changes": [{
      "Action": "CREATE", 
      "ResourceRecordSet": {
        "Name": "cdn.cartaosimples.com",
        "Type": "CNAME",
        "TTL": 300,
        "ResourceRecords": [{"Value": "d111111abcdef8.cloudfront.net"}]
      }
    }]
  }'
```

---

## üöÄ Configura√ß√£o Bootstrap

### 1. URLs de Produ√ß√£o

Ap√≥s o deploy, as URLs ficam dispon√≠veis:

```
Bootstrap: https://cdn.cartaosimples.com/widget-bootstrap.v1.min.js (1.8KB)
CDN Bundle: https://cdn.cartaosimples.com/widget.v1.min.js (122KB)  
CSS: https://cdn.cartaosimples.com/widget.v1.min.css (4.6KB)
```

### 2. Integra√ß√£o B√°sica

```html
<!-- M√©todo 1: Data attributes -->
<script 
  src="https://cdn.cartaosimples.com/widget-bootstrap.v1.min.js"
  data-merchant-id="merchant-123"
  data-primary="#FF6600" 
  data-secondary="#0A0A0A"
  data-logo="https://seusite.com/logo.png"
  data-env="production"
  async>
</script>
```

```html
<!-- M√©todo 2: Configura√ß√£o JavaScript -->
<script src="https://cdn.cartaosimples.com/widget-bootstrap.v1.min.js" async></script>
<script>
  window.PaymentWidgetInit = {
    merchantId: 'merchant-123',
    primaryColor: '#FF6600',
    onSuccess: (data) => console.log('Sucesso:', data.token)
  };
</script>
```

### 3. Subresource Integrity (SRI)

```bash
# Gerar hash SRI
openssl dgst -sha384 -binary dist/bootstrap/widget-bootstrap.v1.min.umd.cjs | openssl base64 -A
```

```html
<!-- Uso com SRI -->
<script 
  src="https://cdn.cartaosimples.com/widget-bootstrap.v1.min.js"
  integrity="sha384-HASH_GERADO_AQUI"
  crossorigin="anonymous"
  async>
</script>
```

### 4. Fallback e Redund√¢ncia

```html
<script>
  // Carregar com fallback
  (function() {
    var script = document.createElement('script');
    script.src = 'https://cdn.cartaosimples.com/widget-bootstrap.v1.min.js';
    script.async = true;
    script.onerror = function() {
      // Fallback para CDN alternativo
      script.src = 'https://backup-cdn.cartaosimples.com/widget-bootstrap.v1.min.js';
    };
    document.head.appendChild(script);
  })();
</script>
```

---

## üè∑Ô∏è Versionamento

### Estrat√©gia de Vers√µes

```bash
# Semantic Versioning (semver)
# MAJOR.MINOR.PATCH

# PATCH: Bug fixes (1.0.0 ‚Üí 1.0.1)
npm version patch

# MINOR: New features (1.0.1 ‚Üí 1.1.0)  
npm version minor

# MAJOR: Breaking changes (1.1.0 ‚Üí 2.0.0)
npm version major

# Pre-release versions
npm version prerelease --preid=beta   # 1.0.0-beta.1
npm version prerelease --preid=rc     # 1.0.0-rc.1
```

### Git Tags

```bash
# Criar tag manualmente
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# Listar tags
git tag -l

# Deletar tag
git tag -d v1.0.0
git push origin :refs/tags/v1.0.0
```

### Branching Strategy

```bash
# Feature branch
git checkout -b feature/new-payment-method
git push -u origin feature/new-payment-method

# Release branch
git checkout -b release/v1.1.0
# ... fazer release prep
git checkout main
git merge release/v1.1.0
git tag v1.1.0

# Hotfix
git checkout -b hotfix/security-patch
# ... fix cr√≠tico
git checkout main
git merge hotfix/security-patch
git tag v1.0.1
```

---

## üêõ Troubleshooting

### Problemas Comuns

#### **‚ùå npm publish falha**

```bash
# Verificar login
npm whoami

# Verificar registry
npm config get registry

# Limpar cache
npm cache clean --force

# Verificar se vers√£o j√° existe
npm view cartao-simples-widget versions --json
```

#### **‚ùå Build falha**

```bash
# Limpar tudo e reinstalar
rm -rf node_modules/ dist/
npm ci

# Verificar tipos
npm run type-check

# Verificar lint
npm run lint
```

#### **‚ùå CDN n√£o carrega**

```bash
# Testar URLs diretamente
curl -I https://cdn.cartaosimples.com/widget-bootstrap.v1.min.js

# Verificar cache CloudFront
aws cloudfront get-distribution --id E1ABCDEFGHIJKL

# Invalidar cache se necess√°rio
aws cloudfront create-invalidation --distribution-id E1ABCDEFGHIJKL --paths "/*"
```

#### **‚ùå CORS errors**

```bash
# Verificar configura√ß√£o S3 CORS
aws s3api get-bucket-cors --bucket cartao-simples-widget-production

# Reconfigurar se necess√°rio
aws s3api put-bucket-cors --bucket cartao-simples-widget-production --cors-configuration file://cors.json
```

### Debug Mode

```bash
# Build com debug
VITE_DEBUG=true npm run build

# Testar localmente com debug
VITE_DEBUG=true npm run dev
```

### Logs e Monitoramento

```bash
# CloudWatch logs (se configurado)
aws logs describe-log-groups --log-group-name-prefix "/aws/cloudfront/"

# S3 access logs
aws s3 ls s3://cartao-simples-widget-logs/ --recursive

# npm download stats
npm view cartao-simples-widget --json | jq '.downloads'
```

---

## üìä Checklist de Release

### Pr√©-Release

- [ ] ‚úÖ Todos os testes passando
- [ ] ‚úÖ Type check sem erros
- [ ] ‚úÖ Lint sem warnings
- [ ] ‚úÖ Build funciona em todos os targets
- [ ] ‚úÖ Documenta√ß√£o atualizada
- [ ] ‚úÖ CHANGELOG.md atualizado
- [ ] ‚úÖ Vers√£o bumped no package.json

### Release

- [ ] üì¶ Build SDK publicado no npm
- [ ] ‚òÅÔ∏è CDN deployado no S3/CloudFront  
- [ ] üöÄ Bootstrap loader atualizado
- [ ] üè∑Ô∏è Git tag criada e pushed
- [ ] üìÑ Release notes no GitHub
- [ ] ‚úÖ Testes de integra√ß√£o passando
- [ ] üìß Stakeholders notificados

### P√≥s-Release

- [ ] üîç Monitorar erros por 24h
- [ ] üìà Verificar m√©tricas de uso
- [ ] üêõ Fix cr√≠tico se necess√°rio
- [ ] üìö Atualizar documenta√ß√£o se necess√°rio

---

## ü§ù Contribui√ß√£o

### Setup para Contributors

```bash
# Fork do reposit√≥rio no GitHub
git clone https://github.com/SEU_USERNAME/widget.git
cd widget

# Adicionar upstream
git remote add upstream https://github.com/cartao-simples/widget.git

# Criar branch para feature
git checkout -b feature/minha-feature

# Ap√≥s desenvolvimento
git push origin feature/minha-feature
# ... criar Pull Request no GitHub
```

### Code Review Checklist

- [ ] üìù C√≥digo segue style guide
- [ ] üß™ Testes adicionados/atualizados  
- [ ] üìö Documenta√ß√£o atualizada
- [ ] üîí Sem vulnerabilidades de seguran√ßa
- [ ] ‚ö° Performance n√£o degradada
- [ ] ‚ôø Acessibilidade mantida/melhorada

---

**üìû Suporte:** Para d√∫vidas sobre publica√ß√£o, contate dev@cartaosimples.com

**üìñ Docs:** https://docs.cartaosimples.com/widget/publishing